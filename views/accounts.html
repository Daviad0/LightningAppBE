<div class="transition" style="display: inline-block;width:100%;opacity:0;padding-bottom:80px" id="contentToShow">
    

    <div style="position: fixed;bottom:0;left:20px;z-index:999">
        <div style="display:inline-flex;justify-content:center">
            <div class="container c-border c-hover blockcontrol" style="padding:10px 50px 10px 50px;border-radius:8px 0px 0px 0px;border-width:2px 1px 2px 2px" data-partof="usermanage" data-num="1">
                <span style="pointer-events: none;">User Accounts</span>
            </div>
            <div class="container c-border c-hover blockcontrol" style="padding:10px 50px 10px 50px;border-radius:0px;border-width:2px 1px 2px 1px" data-partof="usermanage" data-num="2">
                <span style="pointer-events: none">Roles & Permissions</span>
            </div>
            <div class="container c-border c-hover blockcontrol" style="padding:10px 50px 10px 50px;border-radius:0px 8px 0px 0px;border-width:2px 2px 2px 1px" data-partof="usermanage" data-num="3">
                <span style="pointer-events: none">Subgroup Configuration</span>
            </div>
        </div>
    </div>
   
    <br/>
    <div class="blockitem" data-partof="usermanage" data-num="-1" style="width:100%">
        <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%)">
            <img src="/images/sparkclub.png" style="height:60vh;margin:0px 40px;transition:all 1s ease-in-out;opacity:.4" class="slowlogo"/>
        </div>
        <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);padding:5px 10px;background-color:rgba(0,0,0,0.6);border-radius:8px;opacity:0.6">
            <span class="text color-w">Please Select an Option...</span>
        </div>
    </div>
    <div class="blockitem" data-partof="usermanage" data-num="1" style="width:100%;display:none">
        <div style="display:inline-flex;justify-content:space-between;width:88%">
            <div id="filter" style="width:24%">
                <div style="width:100%">
                    <div class="container c-border c-hover color-m" style="padding:10px 50px 10px 50px;margin:10px" id="create_new_user">
                        Create New User
                    </div>
                </div>
                
                <div class="container c-slighterborder" style="width:100%;padding:30px">
                    <span class="text" style="margin:14px">Filter Users</span>
                    <div>
                        <div style="width:100px;display:inline-block;text-align:left;vertical-align:middle">
                            <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Username:</span>
                        </div>
                        <input type="text" class="text color-d input" id="filter_username" style="display:inline-block;font-size:14px;margin-top:10px;width:60%;padding:10px;vertical-align:middle;" value="" placeholder="Doe-y">
                    </div>
                    <div>
                        <div style="width:100px;display:inline-block;text-align:left;vertical-align:middle">
                            <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Name:</span>
                        </div>
                        <input type="text" class="text color-d input" id="filter_name" style="display:inline-block;font-size:14px;margin-top:10px;width:60%;padding:10px;vertical-align:middle;" value="" placeholder="John Doe">
                    </div>
                    <div>
                        <div style="width:100px;display:inline-block;text-align:left;vertical-align:middle">
                            <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Email:</span>
                        </div>
                        <input type="text" class="text color-d input" id="filter_email" style="display:inline-block;font-size:14px;margin-top:10px;width:60%;padding:10px;vertical-align:middle;" value="" placeholder="john@doe.com">
                    </div>
                    
                    <div class="container c-border c-hover" style="padding:5px;margin:10px" id="users_reload">
                        <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">autorenew</span>
                    </div>
                    <div class="container c-border c-hover" style="padding:5px;margin:10px" id="users_search">
                        <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">search</span>
                    </div>
                    <div class="container c-border c-hover" style="padding:5px;margin:10px" id="users_clearfilter">
                        <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">backspace</span>
                    </div>
                    
                </div>
                
            </div>
            <div id="allUsers" style="width:66%">

            </div>
        </div>
        
    </div>
    <div class="blockitem" data-partof="usermanage" data-num="2" style="width:100%;display:none">
        <div style="display:inline-flex;justify-content:space-between;width:88%">
            <div style="width:20%;text-align:left">
                <span class="text">Roles</span>
                <div class="container c-border c-hover" style="padding:5px;margin:5px" id="role_add">
                    <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">add</span>
                </div>
                <div id="roleList" style="margin-top:10px">

                </div>
                
            </div>
            <div style="width:76%">
                <span class="text color-g" id="permission_placeholder">Please Select a Role to Edit...</span>
                <div class="container c-slightborder" style="width:90%;padding:20px;display:none" id="permissionViewer">
                    <div style="display:inline-flex;justify-content:space-between;width:100%">
                        <input type="text" class="text color-d input" style="display:inline-block;font-size:20px;width:70%;padding:10px;vertical-align:middle;" value="Member" placeholder="Role Name" id="permission_roleName">
                        <div style="display:inline-block;width:20%;">
                            <div style="display: inline-block;vertical-align:middle;width:20px;height:20px;border-radius:20px;background-color:red;margin-right:5px" id="permission_roleColor_preview">

                            </div>
                            <input type="text" class="text color-d input" style="display:inline-block;font-size:20px;width:80%;padding:10px;vertical-align:middle;" value="red" placeholder="Color" id="permission_roleColor">
                        </div>
                        
                        
                        
                    </div>
                    
                    
                    <div id="permissions" style="width: 100%;margin-top:20px;margin-bottom:20px;max-height:40vh;overflow-y:scroll">
                        
                    </div>
                    <div style="width:100%">
                        <div class="container c-border c-hover color-m" style="padding:10px 50px 10px 50px;margin:10px" id="permission_save">
                            Save
                        </div>
                        <div class="container c-border-gray color-g c-hover-gray" style="padding:10px 50px 10px 50px;margin:10px" id="permission_cancel">
                            Cancel
                        </div>
                        <div class="container c-border-red color-r c-hover-red" style="padding:10px 50px 10px 50px;margin:10px" id="permission_delete">
                            Delete
                        </div>
                    </div>
                    
                </div>
            </div>
            
        </div>
    </div>
    <div class="blockitem" data-partof="usermanage" data-num="3" style="width:100%;display:none">
        <div style="display:inline-flex;justify-content:space-between;width:88%">
            <div style="width:30%;text-align:left">
                <span class="text">Subgroups</span>
                <div class="container c-border c-hover" style="padding:5px;margin:5px" id="subgroup_add">
                    <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">add</span>
                </div>
                <div id="subgroupList" style="margin-top:10px">

                </div>
            </div>
            
            <div style="width:66%">
                <span class="text color-g" id="subgroup_placeholder">Please Select a Subgroup to Edit...</span>
                <div class="container c-slightborder" style="width:90%;padding:20px;display:none" id="subgroupViewer">
                    <div style="display:inline-flex;justify-content:space-between;width:100%">
                        <input type="text" class="text color-d input" style="display:inline-block;font-size:20px;width:60%;padding:10px;vertical-align:middle;" value="" placeholder="Subgroup Name" id="subgroup_groupName">
                        <div style="display:inline-block;width:30%;text-align:right">
                            <input type="text" class="text color-d input" style="display:inline-block;font-size:20px;width:80%;padding:10px;vertical-align:middle;" value="" placeholder="Tag" id="subgroup_groupTag">
                        </div>
                        
                        
                        
                    </div>
                    
                    <div style="width: 100%;display:flex;justify-content:space-between;align-items:center;margin:10px 0px">
                        <div style="width:14%;">
                            <div class="c-border bounce blockcontrol" data-partof="manage_subgroup" data-num="0" style="border-radius: 60px;border-width:4px;background-color:#4708c4;width:4.5vw;height:4.5vw;display:inline-block;margin-bottom:10px;margin-top:20px">
                                <span class="material-symbols-rounded color-m" style="width:50%;margin-top:24%;font-size:2.3vw;color:white">home_repair_service</span>
                            </div>
                            <div class="c-border bounce blockcontrol" data-partof="manage_subgroup" data-num="1" style="border-radius: 60px;border-width:4px;background-color:transparent;width:4.5vw;height:4.5vw;display:inline-block;margin-bottom:10px">
                                <span class="material-symbols-rounded color-m" style="width:50%;margin-top:24%;font-size:2.3vw">admin_panel_settings</span>
                            </div>
                            <div class="c-border bounce blockcontrol" data-partof="manage_subgroup" data-num="2" style="border-radius: 60px;border-width:4px;background-color:transparent;width:4.5vw;height:4.5vw;display:inline-block;margin-bottom:20px">
                                <span class="material-symbols-rounded color-m" style="width:50%;margin-top:24%;font-size:2.3vw">flag</span>
                            </div>
                            
                        </div>
                        <div class="blockitem" data-partof="manage_subgroup" data-num="0" style="width: 84%">
                            <div id="features" style="width:100%;margin-top:10px;margin-bottom:20px;max-height:40vh;overflow-y:scroll;overflow-x:hidden">
                        
                            </div>
                        </div>  
                        <div class="blockitem" data-partof="manage_subgroup" data-num="1" style="width: 84%;display:none">
                            <div style="width:100%;margin-top:10px;margin-bottom:20px;max-height:40vh;overflow-y:scroll;overflow-x:hidden">
                                
                                <div style="width: 100%;margin-bottom:20px">
                                    <span class="text" style="display:inline-block;vertical-align:middle">Group Managers</span><br/>
                                    <span class="text" style="font-size:14px;font-weight:500;margin:10px 20px 15px 20px;display:block">These members can manage the settings of this group specifically, looking at all of the features. They are not allowed to view this page to overall configure this, or other subgroups.</span>
                                    <div style="border: 2px solid #4708c4;padding:20px;margin:10px;border-radius:20px;max-height:60px;overflow-y:scroll">
                                        <div style="display:inline-block;vertical-align:middle" id="subgroup_managers">

                                        </div>
                                        <div class="container c-border c-hover" style="padding:5px;margin:3px;vertical-align:middle" id="manager_add">
                                            <span class="material-symbols-rounded" style="font-size:14px;pointer-events:none">add</span>
                                        </div>
                                        
                                        
                                    </div>
                                </div>
                                <div class="checkbox transition permission" data-partof="subgroup_joinable" style="display:inline-block;vertical-align:middle;margin-right:10px" data-checked="NO">
                                
                                </div>
                                <span class="text" style="display:inline-block;vertical-align:middle" id="subgroup_joinable">Open to Join</span>
                                
                            </div>
                        </div>  
                        <div class="blockitem" data-partof="manage_subgroup" data-num="2" style="width: 84%;display:none">
                            <div style="width:100%;margin-top:10px;margin-bottom:20px;max-height:40vh;overflow-y:scroll;overflow-x:hidden">
                                <span class="text color-g" style="display:inline-block;vertical-align:middle"><i>No Outstanding Audit Items...</i></span>
                            </div>
                        </div>  
                        
                        
                    </div>
                   
                    <div style="width:100%">
                        <div class="container c-border c-hover color-m" style="padding:10px 50px 10px 50px;margin:10px" id="subgroup_save">
                            Save
                        </div>
                        <div class="container c-border-gray color-g c-hover-gray" style="padding:10px 50px 10px 50px;margin:10px" id="subgroup_cancel">
                            Cancel
                        </div>
                        <div class="container c-border-red color-r c-hover-red" style="padding:10px 50px 10px 50px;margin:10px" id="subgroup_delete">
                            Delete
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
    <div id="overlayRes_add_manager" style="display: none;"></div>
    <div id="resetPassword" style="display: none;"></div>
    <div id="deleteUser" style="display: none;"></div>
    <div id="createUser" style="display: none;"></div>

</div>
<script>
    Array.from(document.getElementsByClassName("mainlogo")).forEach(e => {
        if(!e.classList.contains("logospin")){
            e.classList.add("logospin");
        }
        
    })
    
    var allUsers = [];
    var subgroups = [];
    var currentRole = "";
    var currentSubgroup = "";
    var roles = [];
    var roleAction = "";
    var subgroupAction = "";

    var features = [{
        name: "Special Attendance",
        code: "special_attendance",
        description: "This subgroup can set when they are meeting overall in the meeting system, in case they have an altered schedule from the rest of the group."
    },
    {
        name: "Announcement Channel",
        code: "announcements",
        description: "This subgroup can post announcements to its members that will show up as push notifications."
    },
    {
        name: "Pages",
        code: "pages",
        description: "This subgroup can create special pages for their subgroup members and other outsides to view."
    }]

    var permissionList = [{
        name: "Administrator",
        code: "*",
        description: "This permission gives this role or user full access to everything inside of the group, including the management of other roles!"
    },
    {
        name: "Representative",
        code: "ADMIN_REPRESENTATIVE",
        description: "This permission designates this role or user as a representative of the group, able to be contacted by the site administrators. They will be able to respond to contacts from outside of the group."
    },
    {
        name: "Manage Landing Page",
        code: "ADMIN_LANDING",
        description: "This permission allows the role or user to manage the content of the landing page, including creating, editing and deleting content."
    },
    {
        name: "Submit to Landing Page",
        code: "ADMIN_LANDING_CREATE",
        description: "This permission allows the role or user to only submit entries to the landing page, not being able to edit or delete any other pieces of content."
    },
    {
        name: "Manage QuickLinks",
        code: "ADMIN_QUICKLINKS",
        description: "This permission allows the role or user to manage all Quicklinks, including creating, editing, and deleting links."
    },
    {
        name: "Submit QuickLinks",
        code: "ADMIN_QUICKLINKS_CREATE",
        description: "This permission allows the role or user to only create QuickLinks, not being able to edit or delete any other QuickLinks."
    },
    {
        name: "Public QuickLinks",
        code: "ADMIN_QUICKLINKS_PUBLIC",
        description: "This permission allows the role or user to create QuickLinks that are public. Being able to create QuickLinks alone does not automatically apply this permission."
    },
    {
        name: "Can Collect Protons",
        code: "COLLECT_PROTONS",
        description: "This permission allows the role or user to collect protons, which are the points system!"
    },
    {
        name: "Manage Meeting Schedule",
        code: "ADMIN_SCHEDULE",
        description: "This permission allows the role or user to have full control over the group's meeting and event schedule, including creating, editing, and deleting events"
    },
    {
        name: "See Meeting Schedule",
        code: "VIEW_SCHEDULE",
        description: "This permission allows the role or user to see the group's meeting schedule in its entirety, including all events and meetings (unless further restricted by custom permissions)."
    },
    {
        name: "Sign In to Meeting",
        code: "VIEW_SCHEDULE_SIGNIN",
        description: "This permission allows the role or user to sign in for attendence, but only to meetings that they are apart of."
    },
    {
        name: "View Own Attendence",
        code: "VIEW_SCHEDULE_ATTENDENCE",
        description: "This permission allows the role or user to see their own attendence, including any history or alterations that were made."
    },
    {
        name: "View Everyone's Attendence",
        code: "VIEW_SCHEDULE_ATTENDENCE_ALL",
        description: "This permission allows the role or user to see everyone's attendence, including any history or alterations that were made."
    },
    {
        name: "Confirm Everyone's Attendence",
        code: "ADMIN_SCHEDULE_ATTENDENCE_CONFIRM",
        description: "This permission allows the role or user to confirm another user's attendence, only if it is already unconfirmed."
    },
    {
        name: "Manage Everyone's Attendence",
        code: "ADMIN_SCHEDULE_ATTENDENCE",
        description: "This permission allows the role or user to manage everyone's attendence records, making any changes that are incorrectly logged."
    },
    {
        name: "Global Subgroup Manager",
        code: "ADMIN_SUBGROUPS_MANAGER",
        description: "This permission automatically specifies the user as a irremovable subgroup manager to every subgroup, meaning they can manage the specific features of the subgroup."
    },
    ]
    

    permissionList.forEach(pI => {
        document.getElementById("permissions").innerHTML += `
        <div style="margin:10px;display:inline-flex;width:80%;justify-content:space-between;align-items:center">
            <div style="width:10%;display:inline-block;vertical-align:middle;">
                <div class="checkbox transition permission" data-partof="${pI.code}" style="display:inline-block;vertical-align:middle;" data-checked="NO">
                                
                </div>
            </div>
            
            <div style="width:90%;display:inline-block;vertical-align:middle;">
                <span class="text" style="font-size:16px;vertical-align:middle;font-weight:800">${pI.name}</span>   <span class="text" style="font-size:16px;vertical-align:middle;font-weight:500"><i>(${pI.code})</i></span><br/>
                <span class="text" style="font-size:14px;vertical-align:middle;font-weight:500">${pI.description}</span>
                
            </div>
        </div>
        `;
    })

    features.forEach(f => {
        document.getElementById("features").innerHTML += `
        <div style="margin:10px;width:80%;display:inline-flex;justify-content:space-between;align-items:center">
            <div class="checkbox transition feature" data-partof="${f.code}" style="display:inline-block;vertical-align:middle;margin-right:20px" data-checked="NO">
                                
            </div>
            <div>
                <div style="width:100%;display:flex;vertical-align:middle;justify-content:center">
                
                    <span class="text" style="font-size:16px;vertical-align:middle;font-weight:800;width:100%">${f.name}</span>
                </div>
                
                <div style="width:100%;display:flex;vertical-align:middle;margin:5px">
                    
                    <span class="text" style="font-size:14px;vertical-align:middle;font-weight:500">${f.description}</span>
                    
                </div>
            </div>
            
        </div>
        `;
    })

    var managers_copy = [];

    function reshowManagers(){
        var mN = 0;
        document.getElementById("subgroup_managers").innerHTML = "";
        managers_copy.forEach(m => {
            //currentSubgroup.managers.forEach(m => {
                                
            document.getElementById("subgroup_managers").innerHTML += `
                <div class="container c-border manager" style="padding: 5px 10px;background-color:#4708c4;display:inline-flex;align-items:center;margin:3px" data-num="${mN}" data-id="${m["id"]}">
                    <div class="removemanager" style="display:inline-block" data-num="${mN}" data-id="${m["id"]}">
                        <span class="material-symbols-rounded color-m" style="color:white;font-size:14px;margin-right:5px" data-num="${mN}" data-id="${m["id"]}">cancel</span>
                    </div>
                    
                    <span class="color-w" style="font-size:12px">${m["username"]}</span>
                </div>
            `;
            mN += 1;
        })
        Array.from(document.getElementsByClassName("removemanager")).forEach(e => {
            e.addEventListener("click", function(evt){
                

                var num = parseInt(evt.srcElement.dataset.num);
                console.log(num);
                console.log(managers_copy);
                managers_copy.splice(num, 1);
                reshowManagers();
                
            })
        });
    }

    document.getElementById("manager_add").addEventListener("click", function(){
        document.getElementById("externalClickAction").dataset.action = "overlay";
        document.getElementById("externalClickAction").dataset.overlay = "add_manager";
        document.getElementById("externalClickAction").click();
    })

    document.getElementById("overlayRes_add_manager").addEventListener("click", function(evt){
        var data = evt.srcElement.innerHTML.split(";");
        console.log(data)
        var name = data[0].split("=")[1];
        var id = data[1].split("=")[1];
        managers_copy.push({
            username: name,
            id: id
        });
        reshowManagers(); 
    });

    var refreshSubgroups = {};
    document.getElementById("createUser").addEventListener("click", function(){
        refreshUsers();
    })
    document.getElementById("create_new_user").addEventListener("click", function(){
        document.getElementById("externalClickAction").dataset.action = "overlay";
        document.getElementById("externalClickAction").dataset.overlay = "create_account";
        document.getElementById("overlay_done").dataset.sendback = "createUser";
        document.getElementById("externalClickAction").click();
    });
    document.getElementById("resetPassword").addEventListener("click", function(evt){
        var data = JSON.parse(evt.srcElement.innerHTML);

        $.ajax({
            url: "/acc/forcereset",
            type: "POST",
            data: {
                id: data.id,
                newPw: data["newPassword"]
            },
            success: function(data){
                refreshUsers();
            }
        })
    });

    document.getElementById("deleteUser").addEventListener("click", function(evt){
        var data = evt.srcElement.innerHTML

        $.ajax({
            url: "/acc/delete",
            type: "POST",
            data: {
                id: data
            },
            success: function(data){
                refreshUsers();
            }
        })
    });


    



    function refreshGroups(){
        $.ajax({
            url: "/group/subgroups",
            success: function(data){
                data = JSON.parse(data);
                if(data["successful"]){
                    subgroups = data["items"];
                    document.getElementById("subgroupList").innerHTML = "";
                    var sN = 0;
                    subgroups.forEach(s => {
                        document.getElementById("subgroupList").innerHTML += `
                        <div class="container c-border c-hover selectgroup" data-num="${sN}" style="padding:10px 30px;width:60%;margin:5px;text-align:center;cursor:pointer;font-size:14px;font-weight:600">
                            ${s.name} [${s.tag.toUpperCase()}]
                        </div>
                        `;
                        sN += 1;
                    })
                    Array.from(document.getElementsByClassName("selectgroup")).forEach(e => {
                        e.addEventListener("click", function(evt){
                            var num = parseInt(evt.srcElement.dataset.num);
                            var group = subgroups[num];
                            currentSubgroup = group;
                            subgroupAction = "edit";
                            document.getElementById("subgroup_groupTag").disabled = true;
                            document.getElementById("subgroup_groupTag").style.opacity = 0.6;
                            document.getElementById("subgroup_delete").style.display = "";
                            document.getElementById("subgroup_joinable").dataset.checked = group.joinable ? "YES" : "NO";
                            document.getElementById("subgroup_joinable").style.backgroundColor = group.joinable ? "#4708c4" : "#ffffff";

                            managers_copy = [];
                            group.managers.forEach(m => {
                                try{
                                    var userObj = allUsers.find(u => u.id == m);
                                    managers_copy.push({
                                        username: userObj["username"],
                                        id: userObj["id"]
                                    });
                                }catch(e){

                                }
                                
                            })
                            
                            
                            reshowManagers();
                            Array.from(document.getElementsByClassName("feature")).forEach(e => {
                                e.dataset.checked = "NO";
                                e.style.backgroundColor = "#ffffff";
                            })
                            
                            group.features.forEach(f => {
                                document.querySelector(`.feature[data-partof="${f}"]`).dataset.checked = "YES";
                                document.querySelector(`.feature[data-partof="${f}"]`).style.backgroundColor = "#4708c4";
                            });
                            document.getElementById("subgroup_groupName").value = group.name;
                            document.getElementById("subgroup_groupTag").value = group.tag;
                            document.getElementById("subgroupViewer").style.display = "";
                            document.getElementById("subgroup_placeholder").style.display = "none";
                            

                            Array.from(document.querySelectorAll(".selectgroup")).forEach(e => {
                                console.log(e.dataset.num + " " + num)
                                if(parseInt(e.dataset.num) == num){
                                    e.style.backgroundColor = e.dataset.tocolor == undefined ? "#4708c4" : e.dataset.tocolor;
                                    e.style.color = "white"
                                    try{
                                        e.children[0].style.color = "white";
                                    }catch(e){

                                    }
                                    
                                }else{
                                    e.style.backgroundColor = "";
                                    e.style.color = "";
                                    try{
                                        e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;
                                    }catch(e){

                                    }
                                    
                                }
                            });
                        });
                    });
                }
            },
            error: function(data){
                document.getElementById("showErrorMessage").click();
            }
        })
    }
    function refreshPermissions(){
        $.ajax({
            url: "/group/roles",
            success: function(data){
                data = JSON.parse(data);
                if(data["successful"]){
                    roles = data["items"];

                    document.getElementById("roleList").innerHTML = "";
                    var rN = 0;
                    roles.forEach(r => {
                        document.getElementById("roleList").innerHTML += `
                            <div class="container c-border selectrole" data-num="${rN}" data-toColor="${r.color}" style="padding:10px 30px;width:60%;margin:5px;text-align:center;cursor:pointer;border:2px solid ${r.color}">
                                <span class="text" style="font-size:14px;pointer-events:none;color:${r.color}">${r.name.toUpperCase()}</span>
                            </div>
                        `;
                        rN += 1;
                    });

                    Array.from(document.getElementsByClassName("showrole")).forEach(e => {
                        var name = e.dataset.role;
                        var role = roles.find(r => r.name == name);
                        if(role != undefined){
                            e.style.backgroundColor = role.color;
                            e.style.borderColor = role.color;
                            e.children[0].innerHTML = role.name.toUpperCase();
                        }else{
                            e.style.backgroundColor = "gray";
                            e.style.borderColor = "gray";
                            e.children[0].innerHTML = "???";
                        }
                    })

                    Array.from(document.getElementsByClassName("selectrole")).forEach(e => {
                        e.addEventListener("click", function(evt){
                            var num = parseInt(evt.srcElement.dataset.num);
                            roleAction = "edit";
                            var role = roles[num];
                            currentRole = role;
                            document.getElementById("permission_delete").style.display = "";
                            document.getElementById("permission_roleName").value = role.name;
                            document.getElementById("permission_roleColor").value = role.color;
                            document.getElementById("permissionViewer").style.display = "";
                            document.getElementById("permission_placeholder").style.display = "none";
                            document.getElementById("permission_roleColor_preview").style.backgroundColor = role.color;


                            Array.from(document.getElementsByClassName("permission")).forEach(e => {
                                e.dataset.checked = "NO";
                                e.style.backgroundColor = "white";
                            });
                            role.permissions.forEach(p => {
                                if(document.querySelector(".permission[data-partof='" + p + "']") != null){
                                    document.querySelector(".permission[data-partof='" + p + "']").dataset.checked = "YES";
                                    document.querySelector(".permission[data-partof='" + p + "']").style.backgroundColor = "#4708c4";
                                }
                                
                            })

                            Array.from(document.querySelectorAll(".selectrole")).forEach(e => {
                                if(e.dataset.num == num){
                                    e.style.backgroundColor = e.dataset.tocolor == undefined ? "#4708c4" : e.dataset.tocolor;;
                                    e.children[0].style.color = "white";
                                }else{
                                    e.style.backgroundColor = "";
                                    e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;;
                                }
                            });
                        });
                    });
                    refreshUsers();
                }
            },
            error: function(data){
                document.getElementById("showErrorMessage").click();
            }
        })
    }

    var existingMemberships = [];
    var usersExtended = [];

    document.getElementById("filter_username").addEventListener('change', function(evt){
        localRefreshUsers();
    })

    document.getElementById("filter_name").addEventListener('change', function(evt){
        localRefreshUsers();
    })

    document.getElementById("filter_email").addEventListener('change', function(evt){
        localRefreshUsers();
    })

    function localRefreshUsers(){

        var username = document.getElementById("filter_username").value == "" ? "ADHASJDASKDJ" : document.getElementById("filter_username").value;
        var name = document.getElementById("filter_name").value == "" ? "ADHASJDASKDJ" : document.getElementById("filter_name").value;
        var email = document.getElementById("filter_email").value == "" ? "ADHASJDASKDJ" : document.getElementById("filter_email").value;


        var filteredUsers = allUsers.filter(u => {
            var a = u.username.toLowerCase().includes(username.toLowerCase()) || u.fullname.toLowerCase().includes(name.toLowerCase()) || u.email.toLowerCase().includes(email.toLowerCase());
            return a;
        })

        if(document.getElementById("filter_username").value == "" && document.getElementById("filter_name").value == "" && document.getElementById("filter_email").value == ""){
            filteredUsers = allUsers;
        }



        document.getElementById("allUsers").innerHTML = "";


        filteredUsers.forEach(u => {
            var exists = !(roles.find(r => r["name"] == u["access"]["role"]) == undefined);
            var color = !exists ? "gray" : roles.find(r => r["name"] == u["access"]["role"])["color"];
            var rs = "";
            roles.forEach(r => {
                rs += `<option class="dropdown_option" style="display:none" data-partof="dropdown_${u.id}" value="${r.name}">${r.name.toUpperCase()}</option>`;
            })
            var ss = "";
            u["access"]["groups"].forEach(g => {
                ss += g + ",";

            });
            if(ss.length > 0){
                ss = ss.substring(0, ss.length - 1);
            }
            
            document.getElementById("allUsers").innerHTML += `
                <div class="container c-slightborder" style="width:100%;padding:20px;margin-bottom:10px;">
                    <div class="blockitem" data-partof="u_${u["id"]}" data-num="0" style="width:100%;${usersExtended.includes(u["id"]) ? "display:none" : ""}">
                        <div style="display:inline-flex;justify-content:space-between;align-items:center;width:100%">
                            <div style="width:16%;text-align:left">
                                <div>
                                    <span class="text color-d" style="pointer-events: none;margin-left:10px;font-size:14px;display:block">${u["username"]}</span>
                                    <span style="pointer-events: none;margin-left:10px;font-size:10px;display:block">${u["fullname"]}</span>
                                </div>
                                
                            </div>
                            <div style="width:20%;text-align:left"">
                                <div class="container c-border showrole" style="padding:5px 20px;background-color:${color};border:2px solid ${color}" data-role="${u["access"]["role"]}">
                                    <span class="color-w" style="font-size:12px">${exists ? u["access"]["role"].toUpperCase() : "???"}</span>
                                    
                                </div>
                            </div>
                            <div style="width:28%;text-align:left;">
                                ${
                                    u["email"] == undefined ? `
                                    <span style="pointer-events: none;margin-left:10px"><i>Email Not Found</i></span>
                                    ` : `
                                    <div class="blockitem" data-partof="u_${u.id}_email" data-num="0">
                                        <div style="display:inline-flex;justify-content:space-between;width:100%;align-items:center">
                                            <span style="pointer-events: none;margin-left:10px;font-size:12px">*******@${u["email"].split("@")[1]}</span>
                                            <div class="container c-border c-hover blockcontrol" style="padding:5px;margin:1px" data-partof="u_${u.id}_email" data-num="1">
                                                <span class="material-symbols-rounded" style="font-size:16px">visibility</span>
                                            </div>
                                        </div>
                                        
                                    </div>
                                    <div class="blockitem" data-partof="u_${u.id}_email" data-num="1" style="display:none;">
                                        <div style="display:inline-flex;justify-content:space-between;width:100%;align-items:center">
                                            <span style="pointer-events: none;margin-left:10px;font-size:12px">${u["email"]}</span>
                                            <div class="container c-border c-hover blockcontrol" style="padding:5px;margin:1px" data-partof="u_${u.id}_email" data-num="0">
                                                <span class="material-symbols-rounded" style="font-size:16px">visibility_off</span>
                                            </div>
                                        </div>
                                        
                                    </div>
                                    `


                                }
                                
                                
                            </div>
                            <div style="width:16%;text-align:right">
                                <div class="container c-border c-hover blockcontrol user_extend" style="padding:5px;margin:1px" data-partof="u_${u.id}" data-num="1">
                                    <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">edit</span>
                                </div>
                                <div class="container c-border-red c-hover-red color-r" style="padding:5px;margin:1px" data-partof="u_${u.id}">
                                    <span class="material-symbols-rounded" style="font-size:16px">delete</span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    <div class="blockitem" data-partof="u_${u["id"]}" data-num="1" style="width:100%;${!usersExtended.includes(u["id"]) ? "display:none" : ""}">
                        <div style="display:inline-flex;justify-content:space-between;align-items:center;width:100%">
                            <div style="width:50%;text-align:left">
                                <input type="text" class="text color-d input user_username" style="display:inline-block;font-size:16px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:100%" value="${u["username"]}" data-partof="u_${u.id}" placeholder="Username">
                                
                            </div>
                            <div style="width:16%;text-align:right">
                                <div class="container c-border c-hover blockcontrol saveuser user_contract" style="padding:5px;margin:1px" data-partof="u_${u.id}" data-num="0">
                                    <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">check</span>
                                </div>
                                <div class="container c-border c-hover blockcontrol user_contract" style="padding:5px;margin:1px" data-partof="u_${u.id}" data-num="0">
                                    <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">close</span>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
                            <div style="margin:20px;width:50%">
                                <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                                    <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Full Name</span>
                                    <input type="email" class="text color-d input user_fullname" style="display:inline-block;font-size:16px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:60%" data-partof="u_${u.id}" value="${u["fullname"]}" placeholder="John Doe">
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                                    <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Email Address</span>
                                    <input type="email" class="text color-d input user_email" style="display:inline-block;font-size:16px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:60%" data-partof="u_${u.id}" value="${u["email"]}" placeholder="john.doe@company.com">
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                                    <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">External ID</span>
                                    <input type="email" class="text color-d input user_externalId" style="display:inline-block;font-size:16px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:60%" data-partof="u_${u.id}" value="${u["externalId"] == undefined ? "" : u["externalId"]}" placeholder="20070000">
                                </div>
                                <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                                    <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Notes</span>
                                    <textarea class="text color-d input user_notes" style="display:inline-block;font-size:12px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:60%;height:80px;resize:none;border-radius:20px" data-partof="u_${u.id}" placeholder="Stuffs">${u["notes"]}</textarea>
                                </div>
                                <div class="container c-border-red c-hover-red color-r reset_password" style="padding:10px 50px 10px 50px;margin:10px;font-size:14px" data-partof="u_${u.id}">
                                    Reset Password
                                </div>
                                
                            </div>
                            <div style="width:40%">
                                
                                <div style="display:flex;justify-content:space-between;align-items:center;width:100%;margin:20px 0px">
                                    <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Role Access</span>
                                    <div class="container c-border dropdown user_role" data-partof="dropdown_${u.id}" style="cursor:pointer;style="display:inline-block;vertical-align:middle" data-value="${u.access.role}">
                                        <span class="dropdown_text" style="float:left;margin-right:20px;opacity:0.5;margin-left:5px;pointer-events:none" data-partof="dropdown_${u.id}">Select an Option</span>
                                        <span class="material-symbols-rounded color-d dropdown_icon" style="float:right;font-size:20px" data-partof="dropdown_${u.id}">expand_more</span>
                                        ${rs}
                                        
                                    </div>
                                </div>
                                <span class="text color-d" style="font-size:16px;margin:5px;display:block">A Part of Subgroups:</span>
                                <div style="border: 2px solid #4708c4;padding:20px;margin:10px;border-radius:20px;max-height:60px;overflow-y:scroll">
                                    <div style="display:inline-block;vertical-align:middle" class="memberships" data-partof="u_${u.id}">

                                    </div>
                                    <div class="container c-border c-hover addmembership" style="padding:5px;margin:3px;vertical-align:middle;pointer-events:all" data-partof="u_${u.id}" data-subgroups="${ss}">
                                        <span class="material-symbols-rounded" style="font-size:14px;pointer-events:none">add</span>
                                        
                                        
                                    </div>
                                    

                                    
                                    
                                </div>
                                <div class="container c-border c-hover color-m user_protons" style="padding:10px 50px 10px 50px;margin:10px;font-size:14px" data-partof="u_${u.id}">
                                    See Proton Record
                                </div>
                                <div class="container c-border c-hover color-m user_protons_add" style="padding:10px 50px 10px 50px;margin:10px;font-size:14px" data-partof="u_${u.id}">
                                    Manual Proton Entry
                                </div>
                                
                               
                            </div>
                            
                        </div>
                        
                    </div>
                </div>
                `;
            
            var showEvent = false;


            function showSubgroups(){
                var sN = 0;
                document.querySelector(`.memberships[data-partof="u_${u.id}"]`).innerHTML = "";

                let existing = document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups.split(",");
                if(document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups == ""){
                    existing = [];
                }
                existing.forEach(m => {
                    document.querySelector(`.memberships[data-partof="u_${u.id}"]`).innerHTML += `
                    <div class="container c-border subgroup" style="padding: 5px 10px;background-color:#4708c4;display:inline-flex;align-items:center;margin:3px" data-num="${sN}">
                        <div class="remove" style="display:inline-block" data-num="${sN}" data-id="${m}" data-partof="u_${u.id}">
                            <span class="material-symbols-rounded color-m" style="color:white;font-size:14px;margin-right:5px" data-num="${sN}">cancel</span>
                            
                        </div>
                        
                        <span class="color-w" style="font-size:12px">${m}</span>
                    </div>`;
                    sN += 1;
                })
                $.ajax({
                    url: "/group/subgroups",
                    success: function(data){
                        data = JSON.parse(data);
                        if(data["successful"]){
                            overlayData["subgroups"] = data["items"];
                            var added = 0;
                            document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).innerHTML = `<span class="material-symbols-rounded" style="font-size:14px;pointer-events:none">add</span>`;
                            let existing = document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups.split(",");
                            data["items"].forEach(m => {
                                if(!existing.includes(m.name)){
                                    document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).innerHTML += `<option class="dropdown_option" style="display:none" data-partof="u_${u.id}" value="${m.name}">${m.name}</option>`;
                                    added += 1;
                                }
                                
                            });
                            if(added == 0){
                                document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).style.display = "none";
                            }
                            if(!showEvent){
                                document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).addEventListener("click", function(evt) {
                                    var partof = evt.srcElement.dataset.partof;
                                    
                                    var elementLoc = evt.srcElement.getBoundingClientRect();
                                    var documentRect = document.body.getBoundingClientRect();
                                    var existing = document.querySelector(`.dropdown_option_container[data-partof="${partof}"]`)
                                    if(existing == undefined || existing == null){
                                        var newElement = document.createElement("div");
                                        newElement.classList.add("dropdown-content");
                                        newElement.dataset.partof = partof;
                                        newElement.style.position = "absolute";
                                        newElement.style.top = elementLoc.top-90+80 + "px" + window.scrollY;
                                        newElement.style.width = "160px";
                                        newElement.dataset.normY = elementLoc.top-90+80;
                                        newElement.style.left = elementLoc.left-(documentRect.width/4)+360 + "px";
                                        
                                        newElement.style.transform = "translateX(-50%)";
                    
                                        var addHTML = "";
                                        var options = Array.from(document.querySelectorAll(`.dropdown_option[data-partof="${partof}"]`));
                    
                                        for(var i = 0; i < options.length; i++){
                                            var e = options[i];
                                            addHTML += `
                                            <div data-value="${e.value}" data-partof="${partof}" style="padding:5px 0px;width:160px;border-radius:8px;margin:2px 0px" class="dropdown_option_show transition">
                                                ${e.innerHTML}
                                            </div>
                                            `;
                                        }
                    
                                        newElement.innerHTML = `
                                        <div class="container c-slightborder dropdown_option_container" style="width:160px;border-radius:16px" data-partof="${partof}">
                                            ${addHTML}
                                        </div>
                                        `
                                        
                                        evt.srcElement.appendChild(newElement)
                                    }else{
                                        if(evt.srcElement.classList.contains("dropdown_option_show")){
                                            console.log("AAA");
                                            var newValue = evt.srcElement.dataset.value;
                                            var newText = evt.srcElement.innerHTML;
                                            let existing = document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups.split(",");
                                            if(document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups == ""){
                                                existing = [];
                                            }
                                            existing.push(newValue);
                                            var putBack = "";
                                            existing.forEach(e => {
                                                putBack += `${e},`;
                                            });
                                            if(putBack.length > 0){
                                                putBack = putBack.substring(0, putBack.length-1);
                                            }
                                            document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups = putBack;
                                            showSubgroups();
                                            
                                        }
                                        existing.remove();
                                    }
                                
                                
                                }); 
                                showEvent = true;
                            }

                            
                            
                        }

                    }
                })
            }
            
            
            showSubgroups();
            Array.from(document.getElementsByClassName("blockcontrol")).forEach(e => {
                e.addEventListener("click", function(evt) {
                    var num = evt.srcElement.dataset.num;
                    var partof = evt.srcElement.dataset.partof;
                    var toColor = evt.srcElement.dataset.toColor;
                    console.log(toColor);
        
                    Array.from(document.querySelectorAll(".blockitem[data-partof='" + partof + "']")).forEach(e => {
                        if(e.dataset.num == num){
                            e.style.display = "block";
                        }else{
                            e.style.display = "none";
                        }
                    });
        
                    Array.from(document.querySelectorAll(".blockcontrol[data-partof='" + partof + "']")).forEach(e => {
                        if(e.dataset.num == num){
                            e.style.backgroundColor = e.dataset.tocolor == undefined ? "#4708c4" : e.dataset.tocolor;
                            e.children[0].style.color = "white";
                        }else{
                            e.style.backgroundColor = "";
                            e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;
                        }
                    });
                });
            });

            Array.from(document.getElementsByClassName("remove")).forEach(e => {
                e.addEventListener("click", function(evt) {
                    var uid = evt.srcElement.dataset.partof.split("_")[1];
                    var name = evt.srcElement.dataset.id;


                    let existing = document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups.split(",");
                    if(document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups == ""){
                        existing = [];
                    }

                    var putBack = "";
                    existing.forEach(e => {
                        if(e != name){
                            putBack += `${e},`;
                        }
                    });
                    if(putBack.length > 0){
                        putBack = putBack.substring(0, putBack.length-1);
                    }
                    document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups = putBack;
                    showSubgroups();
                    


                });
            
            });

            Array.from(document.getElementsByClassName("user_extend")).forEach(e => {
                e.addEventListener("click", function(evt){
                    
                    var id = evt.srcElement.dataset.partof.split("_")[1];
                    if(!usersExtended.includes(id)){
                        usersExtended.push(id);
                    }
                });
            });

            Array.from(document.getElementsByClassName("user_delete")).forEach(e => {
                e.addEventListener("click", function(evt){
                    
                    var id = evt.srcElement.dataset.partof.split("_")[1];
                    document.getElementById("externalClickAction").dataset.action = "overlay";
                    document.getElementById("externalClickAction").dataset.overlay = "confirm";
                    document.getElementById("overlay_done").dataset.sendback = "deleteUser";
                    document.getElementById("externalClickAction").dataset.data = JSON.stringify({
                        "id": id,
                        "title": "Are You Sure?",
                        "message": "You are about to delete the user "+ allUsers.find(u => u.id == id).username+ " from the system. They will not be able to log back in, and all of their data, including Attendance, Membership, and Messages will be deleted! Please confirm the action below..."
                    })
                    document.getElementById("externalClickAction").click();
                });
            });

            Array.from(document.getElementsByClassName("user_protons")).forEach(e => {
                e.addEventListener("click", function(evt){
                    
                    var id = evt.srcElement.dataset.partof.split("_")[1];
                    document.getElementById("externalClickAction").dataset.action = "overlay";
                    document.getElementById("externalClickAction").dataset.overlay = "see_protons";
                    document.getElementById("overlay_done").dataset.sendback = "createMeeting";
                    document.getElementById("externalClickAction").dataset.data = JSON.stringify({
                        "id": id,
                        "username": allUsers.find(u => u.id == id).username,
                        "protonLog": allUsers.find(u => u.id == id).protonLog
                    })
                    document.getElementById("externalClickAction").click();
                });
            })

            Array.from(document.getElementsByClassName("user_protons_add")).forEach(e => {
                e.addEventListener("click", function(evt){
                    
                    var id = evt.srcElement.dataset.partof.split("_")[1];
                    document.getElementById("externalClickAction").dataset.action = "overlay";
                    document.getElementById("externalClickAction").dataset.overlay = "add_protons";
                    document.getElementById("overlay_done").dataset.sendback = "createMeeting";
                    document.getElementById("externalClickAction").dataset.data = JSON.stringify({
                        "id": id,
                        "username": allUsers.find(u => u.id == id).username,
                        "protonLog": allUsers.find(u => u.id == id).protonLog
                    })
                    document.getElementById("externalClickAction").click();
                });
            })

            Array.from(document.getElementsByClassName("reset_password")).forEach(e => {
                e.addEventListener("click", function(evt){
                    
                    var id = evt.srcElement.dataset.partof.split("_")[1];
                    document.getElementById("externalClickAction").dataset.action = "overlay";
                    document.getElementById("externalClickAction").dataset.overlay = "force_reset_password";
                    document.getElementById("overlay_done").dataset.sendback = "resetPassword";
                    document.getElementById("externalClickAction").dataset.data = JSON.stringify({
                        "id": id,
                        "username": allUsers.find(u => u.id == id).username
                    })
                    document.getElementById("externalClickAction").click();
                });
            })

            Array.from(document.getElementsByClassName("user_contract")).forEach(e => {
                e.addEventListener("click", function(evt){
                    var id = evt.srcElement.dataset.partof.split("_")[1];
                    if(usersExtended.includes(id)){
                        usersExtended.splice(usersExtended.indexOf(id));
                    }

                    if(!evt.srcElement.classList.contains("saveuser")){
                        localRefreshUsers();
                    }
                    
                });
            });

            Array.from(document.getElementsByClassName("saveuser")).forEach(e => {
                e.addEventListener("click", function(evt) {
                    var uid = evt.srcElement.dataset.partof.split("_")[1];
                    let existing = document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups.split(",");
                    if(document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups == ""){
                        existing = [];
                    }
                    
                    var data = {
                        action: "edit",
                        id: uid,
                        username: document.querySelector(`.user_username[data-partof="u_${uid}"]`).value,
                        email: document.querySelector(`.user_email[data-partof="u_${uid}"]`).value,
                        fullname: document.querySelector(`.user_fullname[data-partof="u_${uid}"]`).value,
                        externalId: document.querySelector(`.user_externalId[data-partof="u_${uid}"]`).value,
                        notes: document.querySelector(`.user_notes[data-partof="u_${uid}"]`).value,
                        role: document.querySelector(`.user_role[data-partof="dropdown_${uid}"]`).dataset.value,
                        subgroups: existing
                    }
                    $.ajax({
                        url: "/group/user",
                        type: "POST",
                        data: data,
                        success: function(data){
                            
                        }
                    })
                    
                    //usersExtended.splice(usersExtended.indexOf(uid));
                });
            });

            
        Array.from(document.getElementsByClassName("dropdown")).forEach(e => {

                    var val = e.dataset.value;
                    var partof = e.dataset.partof;
                    if(val != undefined && val != null && val != ""){
                        var option = e.querySelector(`.dropdown_option[data-partof="${partof}"][value="${val}"]`);
                        if(option != undefined && option != null){
                            document.querySelector(`.dropdown_text[data-partof="${partof}"]`).innerHTML = option.innerHTML;
                            document.querySelector(`.dropdown_text[data-partof="${partof}"]`).style.opacity = 1;
                        }
                    }

                    e.addEventListener("click", function(evt){
                        var partof = evt.srcElement.dataset.partof;
                        
                        var elementLoc = evt.srcElement.getBoundingClientRect();
                        var documentRect = document.body.getBoundingClientRect();
                        var existing = document.querySelector(`.dropdown_option_container[data-partof="${partof}"]`)
                        if(existing == undefined || existing == null){
                            var newElement = document.createElement("div");
                            newElement.classList.add("dropdown-content");
                            newElement.dataset.partof = partof;
                            newElement.style.position = "absolute";
                            newElement.style.top = elementLoc.top-90+80 + "px" + window.scrollY;
                            newElement.dataset.normY = elementLoc.top-90+80;
                            newElement.style.left = elementLoc.left+(elementLoc.width/2)+10 + "px";
                            
                            newElement.style.transform = "translateX(-50%)";

                            var addHTML = "";
                            var options = Array.from(document.querySelectorAll(`.dropdown_option[data-partof="${partof}"]`));

                            for(var i = 0; i < options.length; i++){
                                var e = options[i];
                                addHTML += `
                                <div data-value="${e.value}" data-partof="${partof}" style="padding:5px 0px;width:100%;border-radius:8px;margin:2px 0px" class="dropdown_option_show transition">
                                    ${e.innerHTML}
                                </div>
                                `;
                            }

                            newElement.innerHTML = `
                            <div class="container c-slightborder dropdown_option_container" style="width:${(elementLoc.width-20) + "px"};border-radius:16px" data-partof="${partof}">
                                ${addHTML}
                            </div>
                            `
                            
                            evt.srcElement.appendChild(newElement)
                        }else{
                            if(evt.srcElement.classList.contains("dropdown_option_show")){
                                console.log("AAA");
                                var newValue = evt.srcElement.dataset.value;
                                var newText = evt.srcElement.innerHTML;
                                document.querySelector(`.dropdown[data-partof="${partof}"]`).dataset.value = newValue;
                                document.querySelector(`.dropdown_text[data-partof="${partof}"]`).innerHTML = newText;
                                document.querySelector(`.dropdown_text[data-partof="${partof}"]`).style.opacity = "1";
                            }
                            existing.remove();
                        }
                    
                        
                    });
                });


            




        });
    }

    function refreshUsers(){
        $.ajax({
            url: "/group/users",
            
            success: function(data){
                data = JSON.parse(data);
                if(data["successful"]){
                    
                    document.getElementById("allUsers").innerHTML = "";
                    allUsers = data["items"];
                    roles = data["roles"];
                    console.log(data)
                    refreshSubgroups = {}
                    allUsers.forEach(u => {
                        var exists = !(roles.find(r => r["name"] == u["access"]["role"]) == undefined);
                        var color = !exists ? "gray" : roles.find(r => r["name"] == u["access"]["role"])["color"];
                        var rs = "";
                        roles.forEach(r => {
                            rs += `<option class="dropdown_option" style="display:none" data-partof="dropdown_${u.id}" value="${r.name}">${r.name.toUpperCase()}</option>`;
                        })
                        var ss = "";
                        u["access"]["groups"].forEach(g => {
                            ss += g + ",";

                        });
                        if(ss.length > 0){
                            ss = ss.substring(0, ss.length - 1);
                        }
                        
                        document.getElementById("allUsers").innerHTML += `
                            <div class="container c-slightborder" style="width:100%;padding:20px;margin-bottom:10px;">
                                <div class="blockitem" data-partof="u_${u["id"]}" data-num="0" style="width:100%;${usersExtended.includes(u["id"]) ? "display:none" : ""}">
                                    <div style="display:inline-flex;justify-content:space-between;align-items:center;width:100%">
                                        <div style="width:16%;text-align:left">
                                            <div>
                                                <span class="text color-d" style="pointer-events: none;margin-left:10px;font-size:14px;display:block">${u["username"]}</span>
                                                <span style="pointer-events: none;margin-left:10px;font-size:10px;display:block">${u["fullname"]}</span>
                                            </div>
                                            
                                        </div>
                                        <div style="width:20%;text-align:left"">
                                            <div class="container c-border showrole" style="padding:5px 20px;background-color:${color};border:2px solid ${color}" data-role="${u["access"]["role"]}">
                                                <span class="color-w" style="font-size:12px">${exists ? u["access"]["role"].toUpperCase() : "???"}</span>
                                                
                                            </div>
                                        </div>
                                        <div style="width:28%;text-align:left;">
                                            ${
                                                u["email"] == undefined ? `
                                                <span style="pointer-events: none;margin-left:10px"><i>Email Not Found</i></span>
                                                ` : `
                                                <div class="blockitem" data-partof="u_${u.id}_email" data-num="0">
                                                    <div style="display:inline-flex;justify-content:space-between;width:100%;align-items:center">
                                                        <span style="pointer-events: none;margin-left:10px;font-size:12px">*******@${u["email"].split("@")[1]}</span>
                                                        <div class="container c-border c-hover blockcontrol" style="padding:5px;margin:1px" data-partof="u_${u.id}_email" data-num="1">
                                                            <span class="material-symbols-rounded" style="font-size:16px">visibility</span>
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                                <div class="blockitem" data-partof="u_${u.id}_email" data-num="1" style="display:none;">
                                                    <div style="display:inline-flex;justify-content:space-between;width:100%;align-items:center">
                                                        <span style="pointer-events: none;margin-left:10px;font-size:12px">${u["email"]}</span>
                                                        <div class="container c-border c-hover blockcontrol" style="padding:5px;margin:1px" data-partof="u_${u.id}_email" data-num="0">
                                                            <span class="material-symbols-rounded" style="font-size:16px">visibility_off</span>
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                                `
        
        
                                            }
                                            
                                            
                                        </div>
                                        <div style="width:16%;text-align:right">
                                            <div class="container c-border c-hover blockcontrol user_extend" style="padding:5px;margin:1px" data-partof="u_${u.id}" data-num="1">
                                                <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">edit</span>
                                            </div>
                                            <div class="container c-border-red c-hover-red color-r user_delete" style="padding:5px;margin:1px" data-partof="u_${u.id}">
                                                <span class="material-symbols-rounded" style="font-size:16px">delete</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                </div>
                                <div class="blockitem" data-partof="u_${u["id"]}" data-num="1" style="width:100%;${!usersExtended.includes(u["id"]) ? "display:none" : ""}">
                                    <div style="display:inline-flex;justify-content:space-between;align-items:center;width:100%">
                                        <div style="width:50%;text-align:left">
                                            <input type="text" class="text color-d input user_username" style="display:inline-block;font-size:16px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:100%" value="${u["username"]}" data-partof="u_${u.id}" placeholder="Username">
                                            
                                        </div>
                                        <div style="width:16%;text-align:right">
                                            <div class="container c-border c-hover blockcontrol saveuser user_contract" style="padding:5px;margin:1px" data-partof="u_${u.id}" data-num="0">
                                                <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">check</span>
                                            </div>
                                            <div class="container c-border c-hover blockcontrol user_contract" style="padding:5px;margin:1px" data-partof="u_${u.id}" data-num="0">
                                                <span class="material-symbols-rounded" style="font-size:16px;pointer-events:none">close</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;align-items:center;width:100%">
                                        <div style="margin:20px;width:50%">
                                            <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                                                <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Full Name</span>
                                                <input type="email" class="text color-d input user_fullname" style="display:inline-block;font-size:16px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:60%" data-partof="u_${u.id}" value="${u["fullname"]}" placeholder="John Doe">
                                            </div>
                                            <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                                                <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Email Address</span>
                                                <input type="email" class="text color-d input user_email" style="display:inline-block;font-size:16px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:60%" data-partof="u_${u.id}" value="${u["email"]}" placeholder="john.doe@company.com">
                                            </div>
                                            <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                                                <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">External ID</span>
                                                <input type="email" class="text color-d input user_externalId" style="display:inline-block;font-size:16px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:60%" data-partof="u_${u.id}" value="${u["externalId"] == undefined ? "" : u["externalId"]}" placeholder="20070000">
                                            </div>
                                            <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
                                                <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Notes</span>
                                                <textarea class="text color-d input user_notes" style="display:inline-block;font-size:12px;margin:5px;padding:14px;vertical-align:middle;text-align:left;width:60%;height:80px;resize:none;border-radius:20px" data-partof="u_${u.id}" placeholder="Stuffs">${u["notes"]}</textarea>
                                            </div>
                                            <div class="container c-border-red c-hover-red color-r reset_password" style="padding:10px 50px 10px 50px;margin:10px;font-size:14px" data-partof="u_${u.id}">
                                                Reset Password
                                            </div>
                                        </div>
                                        <div style="width:40%">
                                            <div style="display:flex;justify-content:space-between;align-items:center;width:100%;margin:20px 0px">
                                                <span class="text color-d" style="font-size:14px;font-weight:500;margin-right:5px;">Role Access</span>
                                                <div class="container c-border dropdown user_role" data-partof="dropdown_${u.id}" style="cursor:pointer;style="display:inline-block;vertical-align:middle" data-value="${u.access.role}">
                                                    <span class="dropdown_text" style="float:left;margin-right:20px;opacity:0.5;margin-left:5px;pointer-events:none" data-partof="dropdown_${u.id}">Select an Option</span>
                                                    <span class="material-symbols-rounded color-d dropdown_icon" style="float:right;font-size:20px" data-partof="dropdown_${u.id}">expand_more</span>
                                                    ${rs}
                                                    
                                                </div>
                                            </div>
                                            <span class="text color-d" style="font-size:16px;margin:5px;display:block">A Part of Subgroups:</span>
                                            <div id="refreshSubgroups_${u.id}" style="display:none"></div>
                                            <div style="border: 2px solid #4708c4;padding:20px;margin:10px;border-radius:20px;max-height:60px;overflow-y:scroll">
                                                <div style="display:inline-block;vertical-align:middle" class="memberships" data-partof="u_${u.id}">
        
                                                </div>
                                                <div class="container c-border c-hover addmembership" style="padding:5px;margin:3px;vertical-align:middle;pointer-events:all" data-partof="u_${u.id}" data-subgroups="${ss}">
                                                    <span class="material-symbols-rounded" style="font-size:14px;pointer-events:none">add</span>
                                                    
                                                    
                                                </div>
                                                

                                                
                                                
                                            </div>
                                            <div class="container c-border c-hover color-m user_protons" style="padding:10px 50px 10px 50px;margin:10px;font-size:14px" data-partof="u_${u.id}">
                                                See Proton Record
                                            </div>
                                            <div class="container c-border c-hover color-m user_protons_add" style="padding:10px 50px 10px 50px;margin:10px;font-size:14px" data-partof="u_${u.id}">
                                                Manual Proton Entry
                                            </div>
                                            

                                        </div>
                                        
                                    </div>
                                    
                                </div>
                            </div>
                            `;
                        
                        var showEvent = false;


                        function showSubgroups(){
                            var sN = 0;
                            document.querySelector(`.memberships[data-partof="u_${u.id}"]`).innerHTML = "";

                            let existing = document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups.split(",");
                            if(document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups == ""){
                                existing = [];
                            }
                            existing.forEach(m => {
                                document.querySelector(`.memberships[data-partof="u_${u.id}"]`).innerHTML += `
                                <div class="container c-border subgroup" style="padding: 5px 10px;background-color:#4708c4;display:inline-flex;align-items:center;margin:3px" data-num="${sN}">
                                    <div class="remove" style="display:inline-block" data-num="${sN}" data-id="${m}" data-partof="u_${u.id}">
                                        <span class="material-symbols-rounded color-m" style="color:white;font-size:14px;margin-right:5px" data-num="${sN}">cancel</span>
                                        
                                    </div>
                                    
                                    <span class="color-w" style="font-size:12px">${m}</span>
                                </div>`;
                                sN += 1;
                            })
                            $.ajax({
                                url: "/group/subgroups",
                                success: function(data){
                                    data = JSON.parse(data);
                                    if(data["successful"]){
                                        overlayData["subgroups"] = data["items"];
                                        var added = 0;
                                        document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).innerHTML = `<span class="material-symbols-rounded" style="font-size:14px;pointer-events:none">add</span>`;
                                        let existing = document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups.split(",");
                                        data["items"].forEach(m => {
                                            if(!existing.includes(m.name)){
                                                document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).innerHTML += `<option class="dropdown_option" style="display:none" data-partof="u_${u.id}" value="${m.name}">${m.name}</option>`;
                                                added += 1;
                                            }
                                            
                                        });
                                        if(added == 0){
                                            document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).style.display = "none";
                                        }
                                        if(!showEvent){
                                            document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).addEventListener("click", function(evt) {
                                                var partof = evt.srcElement.dataset.partof;
                                                
                                                var elementLoc = evt.srcElement.getBoundingClientRect();
                                                var documentRect = document.body.getBoundingClientRect();
                                                var existing = document.querySelector(`.dropdown_option_container[data-partof="${partof}"]`)
                                                if(existing == undefined || existing == null){
                                                    var newElement = document.createElement("div");
                                                    newElement.classList.add("dropdown-content");
                                                    newElement.dataset.partof = partof;
                                                    newElement.style.position = "absolute";
                                                    newElement.style.top = elementLoc.top-90+80 + "px" + window.scrollY;
                                                    newElement.style.width = "160px";
                                                    newElement.dataset.normY = elementLoc.top-90+80;
                                                    newElement.style.left = elementLoc.left-(documentRect.width/4)+360 + "px";
                                                    
                                                    newElement.style.transform = "translateX(-50%)";
                                
                                                    var addHTML = "";
                                                    var options = Array.from(document.querySelectorAll(`.dropdown_option[data-partof="${partof}"]`));
                                
                                                    for(var i = 0; i < options.length; i++){
                                                        var e = options[i];
                                                        addHTML += `
                                                        <div data-value="${e.value}" data-partof="${partof}" style="padding:5px 0px;width:160px;border-radius:8px;margin:2px 0px" class="dropdown_option_show transition">
                                                            ${e.innerHTML}
                                                        </div>
                                                        `;
                                                    }
                                
                                                    newElement.innerHTML = `
                                                    <div class="container c-slightborder dropdown_option_container" style="width:160px;border-radius:16px" data-partof="${partof}">
                                                        ${addHTML}
                                                    </div>
                                                    `
                                                    
                                                    evt.srcElement.appendChild(newElement)
                                                }else{
                                                    if(evt.srcElement.classList.contains("dropdown_option_show")){
                                                        console.log("AAA");
                                                        var newValue = evt.srcElement.dataset.value;
                                                        var newText = evt.srcElement.innerHTML;
                                                        let existing = document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups.split(",");
                                                        if(document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups == ""){
                                                            existing = [];
                                                        }
                                                        existing.push(newValue);
                                                        var putBack = "";
                                                        existing.forEach(e => {
                                                            putBack += `${e},`;
                                                        });
                                                        if(putBack.length > 0){
                                                            putBack = putBack.substring(0, putBack.length-1);
                                                        }
                                                        document.querySelector(`.addmembership[data-partof="u_${u.id}"]`).dataset.subgroups = putBack;
                                                        showSubgroups();
                                                        
                                                    }
                                                    existing.remove();
                                                }
                                            
                                            
                                            }); 
                                            showEvent = true;
                                        }

                                        
                                        
                                    }
    
                                }
                            })
                        }
                        
                        refreshSubgroups[u.id] = showSubgroups;


                        showSubgroups();
                    });

                    Array.from(document.getElementsByClassName("user_extend")).forEach(e => {
                        e.addEventListener("click", function(evt){
                            
                            var id = evt.srcElement.dataset.partof.split("_")[1];
                            if(!usersExtended.includes(id)){
                                usersExtended.push(id);
                            }
                        });
                    });

                    Array.from(document.getElementsByClassName("user_delete")).forEach(e => {
                        e.addEventListener("click", function(evt){
                            
                            var id = evt.srcElement.dataset.partof.split("_")[1];
                            document.getElementById("externalClickAction").dataset.action = "overlay";
                            document.getElementById("externalClickAction").dataset.overlay = "confirm";
                            document.getElementById("overlay_done").dataset.sendback = "deleteUser";
                            document.getElementById("externalClickAction").dataset.data = JSON.stringify({
                                "id": id,
                                "title": "Are You Sure?",
                                "message": "You are about to delete the user "+ allUsers.find(u => u.id == id).username+ " from the system. They will not be able to log back in, and all of their data, including Attendance, Membership, and Messages will be deleted! Please confirm the action below..."
                            })
                            document.getElementById("externalClickAction").click();
                        });
                    });

                    Array.from(document.getElementsByClassName("user_protons")).forEach(e => {
                        e.addEventListener("click", function(evt){
                            
                            var id = evt.srcElement.dataset.partof.split("_")[1];
                            document.getElementById("externalClickAction").dataset.action = "overlay";
                            document.getElementById("externalClickAction").dataset.overlay = "see_protons";
                            document.getElementById("overlay_done").dataset.sendback = "createMeeting";
                            document.getElementById("externalClickAction").dataset.data = JSON.stringify({
                                "id": id,
                                "username": allUsers.find(u => u.id == id).username,
                                "protonLog": allUsers.find(u => u.id == id).protonLog
                            })
                            document.getElementById("externalClickAction").click();
                        });
                    })

                    Array.from(document.getElementsByClassName("user_protons_add")).forEach(e => {
                        e.addEventListener("click", function(evt){
                            
                            var id = evt.srcElement.dataset.partof.split("_")[1];
                            document.getElementById("externalClickAction").dataset.action = "overlay";
                            document.getElementById("externalClickAction").dataset.overlay = "add_protons";
                            document.getElementById("overlay_done").dataset.sendback = "createMeeting";
                            document.getElementById("externalClickAction").dataset.data = JSON.stringify({
                                "id": id,
                                "username": allUsers.find(u => u.id == id).username,
                                "protonLog": allUsers.find(u => u.id == id).protonLog
                            })
                            document.getElementById("externalClickAction").click();
                        });
                    })

                    Array.from(document.getElementsByClassName("reset_password")).forEach(e => {
                        e.addEventListener("click", function(evt){
                            
                            var id = evt.srcElement.dataset.partof.split("_")[1];
                            document.getElementById("externalClickAction").dataset.action = "overlay";
                            document.getElementById("externalClickAction").dataset.overlay = "force_reset_password";
                            document.getElementById("overlay_done").dataset.sendback = "resetPassword";
                            document.getElementById("externalClickAction").dataset.data = JSON.stringify({
                                "id": id,
                                "username": allUsers.find(u => u.id == id).username
                            })
                            document.getElementById("externalClickAction").click();
                        });
                    })

                    Array.from(document.getElementsByClassName("user_contract")).forEach(e => {
                        e.addEventListener("click", function(evt){
                            var id = evt.srcElement.dataset.partof.split("_")[1];
                            if(usersExtended.includes(id)){
                                usersExtended.splice(usersExtended.indexOf(id));
                            }

                            if(!evt.srcElement.classList.contains("saveuser")){
                                localRefreshUsers();
                            }
                            
                        });
                    });

                    Array.from(document.getElementsByClassName("saveuser")).forEach(e => {
                        e.addEventListener("click", function(evt) {
                            var uid = evt.srcElement.dataset.partof.split("_")[1];
                            let existing = document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups.split(",");
                            if(document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups == ""){
                                existing = [];
                            }
                            
                            var data = {
                                action: "edit",
                                id: uid,
                                username: document.querySelector(`.user_username[data-partof="u_${uid}"]`).value,
                                email: document.querySelector(`.user_email[data-partof="u_${uid}"]`).value,
                                fullname: document.querySelector(`.user_fullname[data-partof="u_${uid}"]`).value,
                                externalId: document.querySelector(`.user_externalId[data-partof="u_${uid}"]`).value,
                                notes: document.querySelector(`.user_notes[data-partof="u_${uid}"]`).value,
                                role: document.querySelector(`.user_role[data-partof="dropdown_${uid}"]`).dataset.value,
                                subgroups: existing
                            }
                            $.ajax({
                                url: "/group/user",
                                type: "POST",
                                data: data,
                                success: function(data){
                                    refreshUsers();
                                    console.log("Refreshing users")
                                }
                            })
                            
                            //usersExtended.splice(usersExtended.indexOf(uid));
                        });
                    });

                    Array.from(document.getElementsByClassName("remove")).forEach(e => {
                        e.addEventListener("click", function(evt) {
                            var uid = evt.srcElement.dataset.partof.split("_")[1];
                            var name = evt.srcElement.dataset.id;
        
        
                            let existing = document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups.split(",");
                            if(document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups == ""){
                                existing = [];
                            }
        
                            var putBack = "";
                            existing.forEach(e => {
                                if(e != name){
                                    putBack += `${e},`;
                                }
                            });
                            if(putBack.length > 0){
                                putBack = putBack.substring(0, putBack.length-1);
                            }
                            document.querySelector(`.addmembership[data-partof="u_${uid}"]`).dataset.subgroups = putBack;


                            refreshSubgroups[uid]();
                            
        
        
                        });
                    
                    });
                    
                Array.from(document.getElementsByClassName("dropdown")).forEach(e => {

                            var val = e.dataset.value;
                            var partof = e.dataset.partof;
                            if(val != undefined && val != null && val != ""){
                                var option = e.querySelector(`.dropdown_option[data-partof="${partof}"][value="${val}"]`);
                                if(option != undefined && option != null){
                                    document.querySelector(`.dropdown_text[data-partof="${partof}"]`).innerHTML = option.innerHTML;
                                    document.querySelector(`.dropdown_text[data-partof="${partof}"]`).style.opacity = 1;
                                }
                            }

                            e.addEventListener("click", function(evt){
                                var partof = evt.srcElement.dataset.partof;
                                
                                var elementLoc = evt.srcElement.getBoundingClientRect();
                                var documentRect = document.body.getBoundingClientRect();
                                var existing = document.querySelector(`.dropdown_option_container[data-partof="${partof}"]`)
                                if(existing == undefined || existing == null){
                                    var newElement = document.createElement("div");
                                    newElement.classList.add("dropdown-content");
                                    newElement.dataset.partof = partof;
                                    newElement.style.position = "absolute";
                                    newElement.style.top = elementLoc.top-90+80 + "px" + window.scrollY;
                                    newElement.dataset.normY = elementLoc.top-90+80;
                                    newElement.style.left = elementLoc.left+(elementLoc.width/2)+10 + "px";
                                    
                                    newElement.style.transform = "translateX(-50%)";

                                    var addHTML = "";
                                    var options = Array.from(document.querySelectorAll(`.dropdown_option[data-partof="${partof}"]`));

                                    for(var i = 0; i < options.length; i++){
                                        var e = options[i];
                                        addHTML += `
                                        <div data-value="${e.value}" data-partof="${partof}" style="padding:5px 0px;width:100%;border-radius:8px;margin:2px 0px" class="dropdown_option_show transition">
                                            ${e.innerHTML}
                                        </div>
                                        `;
                                    }

                                    newElement.innerHTML = `
                                    <div class="container c-slightborder dropdown_option_container" style="width:${(elementLoc.width-20) + "px"};border-radius:16px" data-partof="${partof}">
                                        ${addHTML}
                                    </div>
                                    `
                                    
                                    evt.srcElement.appendChild(newElement)
                                }else{
                                    if(evt.srcElement.classList.contains("dropdown_option_show")){
                                        console.log("AAA");
                                        var newValue = evt.srcElement.dataset.value;
                                        var newText = evt.srcElement.innerHTML;
                                        document.querySelector(`.dropdown[data-partof="${partof}"]`).dataset.value = newValue;
                                        document.querySelector(`.dropdown_text[data-partof="${partof}"]`).innerHTML = newText;
                                        document.querySelector(`.dropdown_text[data-partof="${partof}"]`).style.opacity = "1";
                                    }
                                    existing.remove();
                                }
                            
                                
                            });
                        });


                    
                    Array.from(document.getElementsByClassName("blockcontrol")).forEach(e => {
                        e.addEventListener("click", function(evt) {
                            var num = evt.srcElement.dataset.num;
                            var partof = evt.srcElement.dataset.partof;
                            var toColor = evt.srcElement.dataset.toColor;
                            console.log(toColor);
                
                            Array.from(document.querySelectorAll(".blockitem[data-partof='" + partof + "']")).forEach(e => {
                                if(e.dataset.num == num){
                                    e.style.display = "block";
                                }else{
                                    e.style.display = "none";
                                }
                            });
                
                            Array.from(document.querySelectorAll(".blockcontrol[data-partof='" + partof + "']")).forEach(e => {
                                if(e.dataset.num == num){
                                    e.style.backgroundColor = e.dataset.tocolor == undefined ? "#4708c4" : e.dataset.tocolor;
                                    e.children[0].style.color = "white";
                                }else{
                                    e.style.backgroundColor = "";
                                    e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;
                                }
                            });
                        });
                    });
                    


                }
                document.getElementById("contentToShow").style.opacity = "1";
                Array.from(document.getElementsByClassName("mainlogo")).forEach(e => {
                    if(e.classList.contains("logospin")){
                        e.classList.remove("logospin");
                    }
                    
                })
                
                refreshGroups();
            },
            error: function(data){
                document.getElementById("showErrorMessage").click();
            }
        })
    }
    refreshPermissions();
    

    document.getElementById("permission_roleColor").addEventListener("change", function(evt){
        var color = evt.srcElement.value;
        document.getElementById("permission_roleColor_preview").style.backgroundColor = color;
    })


    document.getElementById("users_reload").addEventListener("click", function(evt){
        refreshUsers();
    
    })

    document.getElementById("users_clearfilter").addEventListener("click", function(evt){
        document.getElementById("filter_username").value = "";
        document.getElementById("filter_name").value = "";
        document.getElementById("filter_email").value = "";
        localRefreshUsers();
    })

    document.getElementById("permission_roleName").addEventListener("change", function(){
        document.getElementById("permission_roleName").value = document.getElementById("permission_roleName").value.toLowerCase();
    })
    document.getElementById("permission_roleName").addEventListener("keydown", function(){
        document.getElementById("permission_roleName").value = document.getElementById("permission_roleName").value.toLowerCase();
    })
    document.getElementById("permission_save").addEventListener("click", function(evt){
        document.getElementById("permission_placeholder").style.display = "";
        document.getElementById("permissionViewer").style.display = "none";
        if(roleAction == "edit"){
            var e = document.querySelector(".selectrole[data-num='" + (roles.indexOf(currentRole)) + "']");
            e.style.backgroundColor = "";
            e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;
            // do saving here
            
            currentRole.oldName = currentRole.name;
            currentRole.name = document.getElementById("permission_roleName").value;
            currentRole.color = document.getElementById("permission_roleColor").value;

            var permissions = [];
            Array.from(document.querySelectorAll(".permission")).forEach(e => {
                if(e.dataset.checked == "YES"){
                    permissions.push(e.dataset.partof);
                }
            });
            currentRole.permissions = permissions;
            currentRole.action = "edit";

            $.ajax({
                url: "/group/role",
                type: "POST",
                data: currentRole,
                success: function(data){
                    refreshPermissions();
                }
            })



        }else if(roleAction == "create"){

            var permissions = [];
            Array.from(document.querySelectorAll(".permission")).forEach(e => {
                if(e.dataset.checked == "YES"){
                    permissions.push(e.dataset.partof);
                }
            });
            var newRole = {
                name: document.getElementById("permission_roleName").value,
                color: document.getElementById("permission_roleColor").value,
                permissions: permissions,
                action: "create"
            }

            $.ajax({
                url: "/group/role",
                type: "POST",
                data: newRole,
                success: function(data){
                    refreshPermissions();
                }
            })

        }
        
    })

    Array.from(document.getElementsByClassName("checkbox")).forEach(e => {
        e.addEventListener("click", function(evt){
            if(evt.srcElement.dataset.checked == "NO"){
                evt.srcElement.style.backgroundColor = "#4708c4";
                evt.srcElement.dataset.checked = "YES";
            }else{
                evt.srcElement.style.backgroundColor = "white";
                evt.srcElement.dataset.checked = "NO";
            }
        });
    });
    document.getElementById("permission_delete").addEventListener("click", function(evt){
        document.getElementById("permission_placeholder").style.display = "";
        document.getElementById("permissionViewer").style.display = "none";
        var e = document.querySelector(".selectrole[data-num='" + (roles.indexOf(currentRole)) + "']");
        e.style.backgroundColor = "";
        e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;

        $.ajax({
            url: "/group/role",
            type: "POST",
            data: {
                name: currentRole.name,
                action: "delete"
            },
            success: function(data){
                refreshPermissions();
            }
        })
    })
    document.getElementById("permission_cancel").addEventListener("click", function(evt){
        document.getElementById("permission_placeholder").style.display = "";
        document.getElementById("permissionViewer").style.display = "none";
        var e = document.querySelector(".selectrole[data-num='" + (roles.indexOf(currentRole)) + "']");
        e.style.backgroundColor = "";
        e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;
        
        
    })

    document.getElementById("subgroup_save").addEventListener("click", function(evt){
        document.getElementById("subgroup_placeholder").style.display = "";
        document.getElementById("subgroupViewer").style.display = "none";
        if(subgroupAction == "edit"){
            currentSubgroup.oldName = currentSubgroup.name;
            currentSubgroup.name = document.getElementById("subgroup_groupName").value;
            currentSubgroup.action = "edit";
            currentSubgroup.features = [];

            Array.from(document.getElementsByClassName("feature")).forEach(e => {
                if(e.dataset.checked == "YES"){
                    currentSubgroup.features.push(e.dataset.partof);
                }
            })
            currentSubgroup.managers = []
            managers_copy.forEach(m => {
                currentSubgroup.managers.push(m.id);
            });
            currentSubgroup.joinable = document.getElementById("subgroup_joinable").dataset.checked == "YES" ? true : false;
            currentSubgroup.tag = document.getElementById("subgroup_groupTag").value;

            $.ajax({
                url: "/group/subgroup",
                type: "POST",
                data: currentSubgroup,
                success: function(data){
                    refreshGroups();
                }
            })
        }else if(subgroupAction == "create"){
            currentSubgroup = {};
            currentSubgroup.name = document.getElementById("subgroup_groupName").value;
            currentSubgroup.action = "create";
            currentSubgroup.features = [];

            Array.from(document.getElementsByClassName("feature")).forEach(e => {
                if(e.dataset.checked == "YES"){
                    currentSubgroup.features.push(e.dataset.partof);
                }
            })
            currentSubgroup.managers = []
            managers_copy.forEach(m => {
                currentSubgroup.managers.push(m.id);
            });
            currentSubgroup.joinable = document.getElementById("subgroup_joinable").dataset.checked == "YES" ? true : false;
            currentSubgroup.tag = document.getElementById("subgroup_groupTag").value;

            $.ajax({
                url: "/group/subgroup",
                type: "POST",
                data: currentSubgroup,
                success: function(data){
                    refreshGroups();
                }
            })
        }
        
        
        
    })


    document.getElementById("subgroup_cancel").addEventListener("click", function(evt){
        document.getElementById("subgroup_placeholder").style.display = "";
        document.getElementById("subgroupViewer").style.display = "none";
        var e = document.querySelector(".selectgroup[data-num='" + (subgroups.indexOf(currentSubgroup)) + "']");
        e.style.backgroundColor = "";
        e.style.color = "";
        e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;
        
        
    })

    document.getElementById("role_add").addEventListener("click", function(evt){
        roleAction = "create";
        document.getElementById("permission_delete").style.display = "none";
        document.getElementById("permission_roleName").value = "";
        document.getElementById("permission_roleColor").value = "";
        document.getElementById("permissionViewer").style.display = "";
        document.getElementById("permission_placeholder").style.display = "none";
        document.getElementById("permission_roleColor_preview").style.backgroundColor = "white";

        if(currentRole != ""){
            var e = document.querySelector(".selectrole[data-num='" + (roles.indexOf(currentRole)) + "']");
            e.style.backgroundColor = "";
            e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;
        }

        Array.from(document.getElementsByClassName("permission")).forEach(e => {
            e.dataset.checked = "NO";
            e.style.backgroundColor = "white";
        });
    });
    document.getElementById("subgroup_add").addEventListener("click", function(evt){
        subgroupAction = "create";
        document.getElementById("subgroup_groupTag").disabled = false;
        document.getElementById("subgroup_groupTag").style.opacity = 1;
        document.getElementById("subgroup_delete").style.display = "";
        document.getElementById("subgroup_joinable").dataset.checked = "NO";
        document.getElementById("subgroup_joinable").style.backgroundColor = "#ffffff";

        managers_copy = [];
        
        
        reshowManagers();
        Array.from(document.getElementsByClassName("feature")).forEach(e => {
            e.dataset.checked = "NO";
            e.style.backgroundColor = "#ffffff";
        })
        
        document.getElementById("subgroup_groupName").value = "";
        document.getElementById("subgroup_groupTag").value = "";
        document.getElementById("subgroupViewer").style.display = "";
        document.getElementById("subgroup_placeholder").style.display = "none";

        Array.from(document.querySelectorAll(".selectgroup")).forEach(e => {
                                
            e.style.backgroundColor = "";
            e.style.color = ""; 
            e.children[0].style.color = e.dataset.tocolor == undefined ? "" : e.dataset.tocolor;
        });
    });


    Array.from(document.getElementsByClassName("blockcontrol")).forEach(e => {
        e.addEventListener("click", function(evt) {
            var num = evt.srcElement.dataset.num;
            var partof = evt.srcElement.dataset.partof;

            Array.from(document.querySelectorAll(".blockitem[data-partof='" + partof + "']")).forEach(e => {
                if(e.dataset.num == num){
                    e.style.display = "block";
                }else{
                    e.style.display = "none";
                }
            });

            Array.from(document.querySelectorAll(".blockcontrol[data-partof='" + partof + "']")).forEach(e => {
                if(e.dataset.num == num){
                    e.style.backgroundColor = "#4708c4";
                    e.children[0].style.color = "white";
                }else{
                    e.style.backgroundColor = "";
                    e.children[0].style.color = "";
                }
            });
        });
    });
</script>