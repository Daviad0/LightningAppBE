<html>
    <head>
        <link rel="stylesheet" href="/css/style.css"/>
        <link rel="stylesheet" href="https://fonts.sandbox.google.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
        <link rel="preconnect" href="https://fonts.googleapis.com"> 
        
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
        <style>
            .material-symbols-rounded {
                pointer-events: none;
              font-variation-settings:
              'FILL' 1,
              'wght' 500,
              'GRAD' 200,
              'opsz' 48
            }
            *{
                font-family: 'Inter', sans-serif;
            
            }

            </style>
    </head>
    <body>
        <div style="position: fixed;bottom:10px;right:20px;z-index:1000">
            <div class="container c-border-red color-r" style="padding:10px 50px 10px 50px;margin:10px;font-weight:600;display:none;opacity:0" id="errorContainer">
                Error: Not Authenticated
            </div>
        </div>
        <div class="overlay_bg" id="overlay" style="display: none;z-index:10000">
            <div class="container c-slightborder" style="position:absolute;width: 50%;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;padding:30px" id="overlayBigBox">
                <div id="overlayBox"></div>
                <div class="container c-border color-g c-hover" style="padding:10px 50px 10px 50px;margin:10px" id="overlay_done">
                    Done
                </div>
                <div class="container c-border-gray color-g c-hover-gray" style="padding:10px 50px 10px 50px;margin:10px" id="overlay_close">
                    Cancel
                </div>
            </div>
            
        </div>
        <div class="header">
            <div>
                <div style="height:100%;width:100%;display:flex;align-items:center;justify-content:space-between">
                    <div class="bigscreen">
                        <div style="display: inline-flex;align-items:center">
                            <span style="display: inline-flex;margin:0px 20px 0px 20px" class="text">SparkClub</span>
                            <div class="a container c-border c-hover goToPage" data-page="home" style="display: inline-flex;margin:0px 10px 0px 10px;padding:10px 20px 10px 20px">
                                Home
                            </div>
                            <div class="a container c-border c-hover goToPage" data-page="about" style="display: inline-flex;margin:0px 10px 0px 10px;padding:10px 20px 10px 20px">
                                About
                            </div>
                            <div class="a container c-border c-hover goToPage" data-page="group/accounts" style="display: inline-flex;margin:0px 10px 0px 10px;padding:10px 20px 10px 20px">
                                Accounts
                            </div>
                            <div class="a container c-border c-hover goToPage" data-page="group/manage" style="display: none;margin:0px 10px 0px 10px;padding:10px 20px 10px 20px">
                                Manage
                            </div>
                        </div>
                    </div>
                    <div class="smallscreen">
                        <div style="display: inline-flex;align-items:center">
                            <span style="display: inline-flex;margin:0px 20px 0px 20px" class="text">SparkClub</span>
                        </div>
                    </div>
                    
                    
                    <div style="display: inline-flex;align-items:center;padding-right:30px">
                        <span style="display: inline-flex;margin:0px 20px 0px 20px;font-size:14px" class="text" id="account_username"><i>Not Signed In</i></span>
                        <div id="account_login" class="a container c-border c-hover color-m triggerDisplay" data-action="show hide hide" data-target="accountC_login accountC_me accountC_create" style="display: inline-flex;margin:0px 10px 0px 10px;padding:10px 20px 10px 20px">
                            <span class="material-symbols-rounded">login</span>
                        </div>
                        <div id="account_create" class="a container c-border c-hover color-m goToPage" data-page="create" style="display: none;margin:0px 10px 0px 10px;padding:10px 20px 10px 20px">
                            <span class="material-symbols-rounded">person_add</span>
                        </div>
                        <div id="account_me" class="a container c-border c-hover color-m triggerDisplay" data-action="show hide hide" data-target="accountC_me accountC_create accountC_login" style="display: inline-flex;margin:0px 10px 0px 10px;padding:10px 20px 10px 20px;display:none">
                            <span class="material-symbols-rounded">face</span>
                        </div>
                    </div>
                </div>
            </div>
            
            
        </div>

        <div class="container c-slightborder" style="position:absolute;top:100px;right:10px;padding:40px;text-align:center;display:none;z-index:5" id="accountC_create">
            <span class="text color-d" style="display: block;margin-bottom:10px">Create Account</span>
            
            <div>
                <div style="width:80px;display:inline-block">
                    <span class="text color-m" style="font-size:12px;font-weight:500;margin-right:5px;width:80px">Group</span>
                </div>
                <input type="text" placeholder="group123" class="input color-m" style="width:200px;margin-top:10px;border:1px solid #4708c4"/>
            </div>
            <br/>
            <div class="a container c-border c-hover goToPage triggerDisplay" data-page="create" data-action="hide" data-target="accountC_create" style="padding:10px 20px 10px 20px">
                Create
            </div>
            <div class="a container c-border-gray c-hover-gray color-g triggerDisplay" data-action="hide" data-target="accountC_create" style="padding:10px 20px 10px 20px">
                Cancel
            </div>
            
            
            
            
        </div>

        <div class="container c-slightborder" style="position:absolute;top:100px;right:10px;padding:40px;text-align:center;display:none;z-index:5" id="accountC_login">
            <span class="text color-d" style="display: block;margin-bottom:10px">Login</span>
            
            <div>
                <div style="width:80px;display:inline-block">
                    <span class="text color-d" style="font-size:12px;font-weight:500;margin-right:5px;">Username</span>
                </div>
                <input type="text" placeholder="johndoe1" class="input color-d" id="login_username" style="width:200px;margin-top:10px"/>
            </div>
            <div>
                <div style="width:80px;display:inline-block">
                    <span class="text color-d" style="font-size:12px;font-weight:500;margin-right:5px">Password</span>
                </div>
                <input type="password" placeholder="password1" class="input color-d" id="login_password" style="width:200px;margin-top:10px"/>
            </div>
            <div>
                <div style="width:80px;display:inline-block">
                    <span class="text color-m" style="font-size:12px;font-weight:500;margin-right:5px;width:80px">Group</span>
                </div>
                <input type="text" placeholder="group123" class="input color-m" id="login_group" style="width:200px;margin-top:10px;border:1px solid #4708c4"/>
            </div>
            <br/>
            <div class="a container c-border c-hover baseaction" data-action="login" style="padding:10px 20px 10px 20px">
                Login
            </div>
            <div class="a container c-border-gray c-hover-gray color-g triggerDisplay" data-action="hide" data-target="accountC_login" style="padding:10px 20px 10px 20px">
                Cancel
            </div>
            
            
            
            
        </div>

        <div class="container c-slightborder" style="position:absolute;top:100px;right:10px;padding:40px;text-align:center;display:none;z-index:5" id="accountC_me">
            <span class="text color-d" style="display: block;margin-bottom:10px" id="ca_username">[ME]</span>
            <span class="text color-d" style="display: block;margin-bottom:10px;font-size:14px" id="ca_group"><i>Part of [group]</i></span>
            
            
            <br/>
            <div class="a container c-border c-hover baseaction" data-action="account" style="padding:10px 20px 10px 20px">
                My Account
            </div>
            <div class="a container c-border-gray c-hover-gray color-g baseaction" data-action="logout" style="padding:10px 20px 10px 20px">
                Logout
            </div>
            
            
            
            
        </div>
        
        <div style="position:absolute;top: 100px;left:-10px;width:100%;text-align:center;height:80%" id="contents">

        </div>

        <div class="baseaction" data-action="none" style="display:none" id="externalClickAction"></div>
        <div class="baseaction" data-action="none" style="display:none" id="reloadBaseEvents"></div>
        <div class="baseaction" data-action="none" style="display:none" id="showErrorMessage"></div>
    </body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qr-creator/dist/qr-creator.min.js"></script>

    <script>

        var authId = "";
        var group = "";
        var overlayData = {};
        var thisUser = undefined;



        function replace(e){
            var new_element = e.cloneNode(true);
            e.parentNode.replaceChild(new_element, e);
        }

        function load(page){
            window.history.pushState("hiya", "Club Mgmt", page);
            
            $.ajax({
                url: "/part" + page,
                headers : {partial : "YES", authorization : authId},
                success: function(data){
                    
                    $("#contents").html(data);
                    reloadAllBaseEvents();
                },
                error: function(data){
                    load("/home");
                }
            });
        }
        try{

            
            var cookies = document.cookie.split(";");
            cookies.forEach(c => {
                var parts = c.split("=");
                if(parts[0] == "session"){
                    authId = parts[1];
                    $.ajax({
                        url: "/acc/verify",
                        headers : {authorization : parts[1]},
                        success: function(data){
                            data = JSON.parse(data);
                            if(data["successful"]){
                                group = data["user"]["group"];
                                thisUser = data["user"];
                                document.getElementById("account_login").style.display = "none";
                                document.getElementById("account_create").style.display = "none";
                                document.getElementById("account_me").style.display = "";
                                document.getElementById("account_username").innerHTML = data["user"]["username"];
                                document.getElementById("accountC_login").style.display = "none";
                                document.getElementById("accountC_me").style.display = "none";
                                document.getElementById("accountC_create").style.display = "none";
                                document.getElementById("ca_username").innerHTML = data["user"]["username"];
                                document.getElementById("ca_group").innerHTML = "Part of " + data["user"]["group"];
                                document.querySelector('div[data-page="group/manage"]').style.display = "inline-flex";
                            }
                        }
                    });
                }
            });
        }catch(e){

        }

        document.getElementById("overlay_done").addEventListener("click", function(evt){
            document.getElementById('overlay').style.display = "none";
            
            var sendback = document.getElementById(evt.srcElement.dataset.sendback);
            var data = "";
            switch(evt.srcElement.dataset.overlay){
                case "create_meeting":
                    break;
                case "add_manager":
                    var username = document.getElementById("overlay_username").value;
                    var id = document.getElementById("overlay_username").dataset.id;
                    data = "user=" + username + ";id=" + id;
                    break;
            }
            if(sendback != null){
                sendback.innerHTML = data;
                sendback.click();
            }
        });
        

        document.getElementById("overlay_close").addEventListener("click", function(evt){
            document.getElementById('overlay').style.display = "none";
            
        });


        

        function reloadAllBaseEvents(){

            Array.from(document.getElementsByClassName("a")).forEach(e => {
                replace(e);
            });

            Array.from(document.getElementsByClassName("baseaction")).forEach(e => {
                e.addEventListener("click", function(evt){
                    switch(evt.srcElement.dataset.action){
                        case "login":
                            $.post("/acc/login", {
                                username: $("#login_username").val(),
                                password: $("#login_password").val(),
                                group: $("#login_group").val()
                            }, function(data){
                                //console.log(data);
                                data = JSON.parse(data);
                                if(data["successful"] == false){
                                    flashFormError(3000, document.getElementById("login_username"));
                                    flashFormError(3000, document.getElementById("login_password"));
                                    flashFormError(3000, document.getElementById("login_group"));
                                }else{
                                    thisUser = data["user"];
                                    document.cookie = "session=" + data["token"];
                                    authId = data["token"];
                                    document.getElementById("account_login").style.display = "none";
                                    document.getElementById("account_create").style.display = "none";
                                    document.getElementById("account_me").style.display = "";
                                    document.getElementById("account_username").innerHTML = data["user"]["username"];
                                    document.getElementById("accountC_login").style.display = "none";
                                    document.getElementById("ca_username").innerHTML = data["user"]["username"];
                                    document.getElementById("ca_group").innerHTML = "Part of " + data["user"]["group"];
                                    document.querySelector('div[data-page="group/manage"]').style.display = "inline-flex";
                                    load("/home");
                                }
                            });
                            
                            break;
                        case "create":
                        $.post("/acc/create", {
                            username: $("#create_username").val(),
                            password: $("#create_password").val(),
                            group: $("#create_groupid").val(),
                            email: $("#create_email").val()
                        }, function(data){
                            //console.log(data);
                            data = JSON.parse(data);
                            if(data["successful"] == false){
                                if(data["error"] == "username"){
                                    flashFormError(3000, document.getElementById("create_username"));
                                }else if(data["error"] == "password"){
                                    flashFormError(3000, document.getElementById("create_password"));
                                }else if(data["error"] == "group"){
                                    flashFormError(3000, document.getElementById("create_groupid"));
                                }else if(data["error"] == "email"){
                                    flashFormError(3000, document.getElementById("create_email"));
                                }
                            }else{
                                authId = data["token"];
                                thisUser = data["user"];
                                document.cookie = "session=" + data["token"];
                                document.getElementById("account_login").style.display = "none";
                                //document.getElementById("account_create").style.display = "none";
                                document.getElementById("account_me").style.display = "";
                                document.getElementById("account_username").innerHTML = data["user"]["username"];
                                document.getElementById("accountC_login").style.display = "none";
                                document.getElementById("ca_username").innerHTML = data["user"]["username"];
                                document.getElementById("ca_group").innerHTML = "Part of " + data["user"]["group"];
                                document.querySelector('div[data-page="group/manage"]').style.display = "inline-flex";
                                load("/home");
                            }
                        });
                            break;
                        case "account":
                            
                        
                            document.getElementById("accountC_me").style.display = "none";
                            if(thisUser != undefined){
                                load("/acc/user/" + thisUser["id"]);
                            }
                            
                            break;
                        case "logout":
                            document.cookie = "session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                            authId = "";
                            document.getElementById("account_login").style.display = "";
                            //document.getElementById("account_create").style.display = "";
                            document.getElementById("account_me").style.display = "none";
                            document.getElementById("accountC_login").style.display = "none";
                            document.getElementById("accountC_me").style.display = "none";
                            document.getElementById("account_username").innerHTML = "<i>Not Signed In</i>";
                            document.getElementById("ca_username").innerHTML = "";
                            document.getElementById("ca_group").innerHTML = "";
                            document.querySelector('div[data-page="group/manage"]').style.display = "none";
                            load("/home");
                            break;
                        case "logattendance":
                            $.ajax({
                                url: "/group/today",
                                type: "POST",
                                data: {
                                    group: group
                                },
                                headers: {authorization: authId},
                                success: function(data){
                                    console.log(data);
                                    data = JSON.parse(data);
                                    if(data["successful"] == true){
                                        load("/home");
                                    }
                                }
                            })
                            break;
                        case "overlay":
                            document.getElementById("overlay_done").dataset.overlay = evt.srcElement.dataset.overlay;
                            switch(evt.srcElement.dataset.overlay){
                                case "create_meeting":
                                    document.getElementById('overlay').style.display = "";
                                    document.getElementById('overlayBox').innerHTML = `
                                    <span class="text color-d" style="font-size:28px">Create a Meeting</span>
                                    <br/>
                                    <div class="a container c-border c-hover" style="padding:10px 20px 10px 20px">
                                        Exit
                                    </div>
                                    `;
                                    break;
                                case "add_manager":
                                    function handleAddManager(evt){
                                        var oldContent = document.querySelector(".overlay_usernameComplete");
                                        if(oldContent != null){
                                            oldContent.remove();
                                        }
                                        var newElement = document.createElement("div");
                                        var elementLoc = evt.srcElement.getBoundingClientRect();
                                        var documentRect = document.body.getBoundingClientRect();
                                        newElement.classList.add("dropdown-content");
                                        newElement.classList.add("overlay_usernameComplete");
                                        newElement.style.position = "absolute";
                                        newElement.style.zIndex = "200";
                                        newElement.style.top = elementLoc.top-90+80 + "px" + window.scrollY;
                                        newElement.dataset.normY = elementLoc.top-90+80;
                                        newElement.style.left = elementLoc.left-(elementLoc.width/2)+10 + "px";
                                        
                                        newElement.style.transform = "translateX(-50%)";
                                        var addHTML = "";
                                        var useUsers = overlayData["users"].filter(u => u["username"].toLowerCase().includes(evt.srcElement.value.toLowerCase()));
                                        useUsers.sort((a, b) => {
                                            if(a["username"].toLowerCase() < b["username"].toLowerCase()){
                                                return -1;
                                            }else if(a["username"].toLowerCase() > b["username"].toLowerCase()){
                                                return 1;
                                            }else{
                                                return 0;
                                            }
                                        });
                                        for(var i = 0; i < (useUsers.length > 5 ? 5 : useUsers.length); i++){
                                            var e = useUsers[i];
                                            addHTML += `
                                            <div data-value="${e.id}" data-username="${e.username}" style="padding:5px 0px;width:100%;border-radius:8px;margin:2px 0px;cursor:pointer" class="dropdown_option_show overlay_username_item transition">
                                                ${e.username}
                                            </div>
                                            `;
                                        }
                                        newElement.innerHTML = `
                                        <div class="container c-slightborder dropdown_option_container" style="width:${(elementLoc.width-20) + "px"};border-radius:16px">
                                            ${addHTML}
                                        </div>
                                        `
                                        
                                        document.getElementById("place_suggestion").appendChild(newElement)

                                        Array.from(document.getElementsByClassName("overlay_username_item")).forEach(function(e){
                                            e.addEventListener("click", function(evt){
                                                var id = evt.srcElement.dataset.value;
                                                var name = evt.srcElement.dataset.username;

                                                document.getElementById("overlay_username").value = name;
                                                document.getElementById("overlay_username").dataset.id = id;
                                                var oldContent = document.querySelector(".overlay_usernameComplete");
                                                if(oldContent != null){
                                                    oldContent.remove();
                                                }
                                                document.getElementById("overlay_done").style.opacity = "1";
                                                document.getElementById("overlay_done").style.pointerEvents = "";
                                                document.getElementById("overlay_done").style.cursor = "pointer";

                                            })
                                        })
                                    }
                                    $.ajax({
                                        url : "/group/users",
                                        type : "GET",
                                        success: function(data){
                                            data = JSON.parse(data);
                                            if(data["successful"]){
                                                overlayData["users"] = data["items"];
                                                document.getElementById("overlay_done").style.opacity = "0.5";
                                                document.getElementById("overlay_done").style.pointerEvents = "none";
                                                document.getElementById("overlay_done").style.cursor = "not-allowed";
                                                document.getElementById('overlay').style.display = "";
                                                document.getElementById("overlay_done").dataset.sendback = "overlayRes_add_manager";
                                                document.getElementById('overlayBox').innerHTML = `
                                                <span class="text color-d" style="font-size:28px;margin:10px">Add a Subgroup Manager</span>
                                                <div style="margin:20px" id="place_suggestion">
                                                    <input class="input" type="text" placeholder="Type a Username" style="width:50%;font-size:16px" id="overlay_username"/>
                                                </div>
                                                
                                                `;
                                                document.getElementById("overlay_username").addEventListener("change", function(evt){
                                                    handleAddManager(evt);
                                                    

                                                });
                                                document.getElementById("overlay_username").addEventListener("keyup", function(evt){
                                                    handleAddManager(evt);
                                                    document.getElementById("overlay_done").style.opacity = "0.5";
                                                    document.getElementById("overlay_done").style.pointerEvents = "none";
                                                    document.getElementById("overlay_done").style.cursor = "not-allowed";
                                                });
                                                document.getElementById("overlay_username").addEventListener("click", function(evt){
                                                    handleAddManager(evt);
                                                    
                                                });
                                                document.getElementById("overlay_username").addEventListener("focusout", function(evt){
                                                    setTimeout(function(){
                                                        var oldContent = document.querySelector(".overlay_usernameComplete");
                                                        if(oldContent != null){
                                                            oldContent.remove();
                                                        }
                                                    },500);
                                                    
                                                })
                                            }
                                        }
                                    })
                                    
                                    break;
                                
                            }
                            break;
                    }
                });
            });

            
            
    
            Array.from(document.getElementsByClassName("goToPage")).forEach(e => {
                
                e.addEventListener("click", function(evt){
                    load("/" + evt.srcElement.dataset.page);
                });
            });

            
    
            Array.from(document.getElementsByClassName("triggerDisplay")).forEach(e => {
                e.addEventListener("click", (evt) => {
                    var action = evt.srcElement.dataset.action.split(" ");
                    var targets = evt.srcElement.dataset.target.split(" ");
    
                    for(var i = 0; i < action.length; i++) {
                        if(action[i] == "show") {
                            document.getElementById(targets[i]).style.display = "block";
                        } else if(action[i] == "hide") {
                            document.getElementById(targets[i]).style.display = "none";
                        }
                    }
                });
            })
            Array.from(document.getElementsByClassName("bounce")).forEach(e => {
                e.addEventListener("click", function() {
                    if(!e.classList.contains("bounce-on")){
                        e.classList.add("bounce-on");
                        setTimeout(function() {
                            e.classList.remove("bounce-on");
                        }, 600);
                    }
                    
                });
            });
        }

        $(document).ready(function(){
            reloadAllBaseEvents();
            let loc = window.location.pathname;
            let cookies = document.cookie.split(";");
            cookies.forEach(e => {
                if(e.split("=")[0] == "ql"){
                    var toGoTo = e.split("=")[1];
                    document.cookie = "ql=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                    window.location = toGoTo;
                    return;
                }
            });
            if(loc == "" || loc == "/" || loc == undefined){
                loc = "/home";
            }
            load(loc);
        });

        function flashFormError(timeout, element){
            element.style.borderColor = "#ff0000";
            element.style.color = "#ff0000";
            setTimeout(function(){
                element.style.borderColor = "";
                element.style.color = "";
            },timeout);
        }
        document.getElementById("showErrorMessage").addEventListener("click", function(evt){
            var el = document.getElementById("errorContainer");
            el.style.display = "";
            setTimeout(function(){
                el.style.opacity = "1";
            },10);
        });
        document.getElementById("reloadBaseEvents").addEventListener("click", function(evt){
            reloadAllBaseEvents();
        })

        
    </script>
</html>